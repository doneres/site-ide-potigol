{% extends "base.html" %}

{% block title %}Atividades Propostas{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Atividades Propostas</h2>
    <p>Escolha um módulo abaixo para ver os desafios correspondentes.</p>
</div>

<div class="module">
    <div class="module-header">
        <h3>Módulo 01: Conceitos Básicos e Saída de Dados</h3>
        <span class="module-toggle-icon">+</span>
    </div>
    <div class="module-content">
        <div class="activities-grid">
            <div class="card" id="atividade-1">
                <div class="card-header">
                    <h4>Atividade 01: Olá, Mundo!</h4>
                    <span class="tag tag-easy">Fácil</span>
                </div>
                <p class="card-description">Crie um programa que imprima a mensagem "Potigol é legal!" na tela.</p>
                <button class="btn-resolver">Resolver Atividade</button>
            </div>
            <div class="card" id="atividade-2">
                <div class="card-header">
                    <h4>Atividade 02: Múltiplas Linhas</h4>
                    <span class="tag tag-easy">Fácil</span>
                </div>
                <p class="card-description">Imprima seu nome completo em uma linha e sua idade em outra linha.</p>
                <button class="btn-resolver">Resolver Atividade</button>
            </div>
        </div>
    </div>
</div>

<div class="module">
    <div class="module-header">
        <h3>Módulo 02: Variáveis e Operadores Aritméticos</h3>
        <span class="module-toggle-icon">+</span>
    </div>
    <div class="module-content">
        </div>
</div>


<div id="activity-modal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h3 id="modal-activity-title">Título da Atividade</h3>
        <p id="modal-activity-description">Descrição da atividade aqui.</p>
        <label for="modal-code-input">Seu código:</label>
        <textarea id="modal-code-input"></textarea>
        <button id="modal-check-answer" class="btn-card">Verificar Resposta</button>
        <div class="modal-output-container">
            <h4>Saída da Verificação:</h4>
            <pre id="modal-output"></pre>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // ====================================================
        // PARTE 1: LÓGICA PARA O MENU SANFONA (DROPDOWNS)
        // ====================================================
        const moduleHeaders = document.querySelectorAll('.module-header');
        moduleHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const moduleContent = header.nextElementSibling;
                const icon = header.querySelector('.module-toggle-icon');

                if (moduleContent.style.maxHeight) {
                    moduleContent.style.maxHeight = null;
                    icon.textContent = '+';
                    header.classList.remove('active');
                } else {
                    moduleContent.style.maxHeight = moduleContent.scrollHeight + "px";
                    icon.textContent = '−';
                    header.classList.add('active');
                }
            });
        });

        // ====================================================
        // PARTE 2: LÓGICA PARA O MODAL DE ATIVIDADES
        // ====================================================
        const modal = document.getElementById('activity-modal');
        const closeModalButton = document.querySelector('.close-button');
        const resolverButtons = document.querySelectorAll('.btn-resolver');
        const checkAnswerButton = document.getElementById('modal-check-answer');
        let modalEditor = null;
        let currentActivityId = null;

        resolverButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const card = e.target.closest('.card');
                const title = card.querySelector('h4').textContent;
                const description = card.querySelector('.card-description').textContent;
                currentActivityId = card.id;

                document.getElementById('modal-activity-title').textContent = title;
                document.getElementById('modal-activity-description').textContent = description;
                document.getElementById('modal-output').textContent = '';
                document.getElementById('modal-output').style.border = 'none';

                modal.style.display = 'flex';

                if (!modalEditor) {
                    modalEditor = CodeMirror.fromTextArea(document.getElementById('modal-code-input'), {
                        lineNumbers: true, mode: 'text/x-csrc', theme: 'eclipse', lineWrapping: true
                    });
                }
                modalEditor.setValue('');
                setTimeout(() => modalEditor.refresh(), 1);
            });
        });
        
        function closeModal() {
            modal.style.display = 'none';
            if (modalEditor) {
                modalEditor.toTextArea();
                modalEditor = null;
            }
        }

        closeModalButton.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });

        checkAnswerButton.addEventListener('click', async () => {
            if (modalEditor) {
                const code = modalEditor.getValue();
                const outputEl = document.getElementById('modal-output');
                outputEl.textContent = 'Verificando...';
                outputEl.style.border = 'none';

                try {
                    const response = await fetch('/verify', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ code: code, activity_id: currentActivityId })
                    });
                    const result = await response.json();
                    
                    outputEl.textContent = result.output;
                    outputEl.style.border = result.correct ? '2px solid #27ae60' : '2px solid #c0392b';

                } catch (error) {
                    outputEl.textContent = 'Erro ao conectar com o backend: ' + error.message;
                }
            }
        });
    });
</script>
{% endblock %}